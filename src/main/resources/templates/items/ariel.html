<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Ariel - Items</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <style>
        body {
            padding: 20px
        }
    </style>
</head>

<body>
    <div th:insert="~{fragments/navbar :: mainNav}"></div>
    <div class="container">
        <h1>Ariel view</h1>
        <div class="mb-3 d-flex align-items-center ariel-actions">
            <a class="btn btn-primary ariel-submit btn-lg" th:href="@{/leftovers}">Submit</a>

            <form th:action="@{/items/set-all-unavailable}" method="post" style="display:inline"
                class="set-all-unavailable-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button class="btn btn-warning ms-2" type="submit">Set All Unavailable</button>
            </form>

            <form th:action="@{/items/set-all-available}" method="post" style="display:inline"
                class="set-all-available-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button class="btn btn-success ms-2" type="submit">Set All Available</button>
            </form>

            <form th:action="@{/items/set-all-kg-available}" method="post" style="display:inline"
                class="set-all-kg-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button class="btn btn-info ms-2" type="submit">Set All KG Available</button>
            </form>
        </div>
        <meta name="_csrf" th:content="${_csrf.token}" />
        <meta name="_csrf_header" th:content="${_csrf.headerName}" />

        <table class="table table-striped" id="itemsTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Available</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="i : ${items}">
                    <td>
                        <div dir="rtl" class="text-end ariel-name" th:text="${i.name}"></div>
                    </td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input avail-toggle" type="checkbox" role="switch"
                                th:attr="data-id=${i.id}" th:checked="${i.available}" />
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <style>
        /* Always enlarge the name column for Ariel view */
        .ariel-name {
            font-size: 3.8rem;
            font-weight: 700;
        }

        /* Make availability toggles larger and position them to the right */
        .avail-toggle {
            transform: scale(4.6);
            margin: 0;
        }

        /* Make the availability column wider (~1.5x) and right-align its content */
        #itemsTable th:nth-child(2),
        #itemsTable td:nth-child(2) {
            width: 150px;
            max-width: 150px;
            text-align: right;
            vertical-align: middle;
            padding-right: 12px;
        }

        /* Ensure the switch sits at the right side of the cell */
        #itemsTable td:nth-child(2) .form-check {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        /* Make submit button larger for Ariel view */
        .ariel-submit {
            padding: 0.75rem 1.25rem;
            font-size: 1.1rem;
        }

        /* Enlarge all top action buttons in Ariel view */
        .ariel-actions .btn {
            padding: 0.9rem 1.4rem;
            font-size: 2.15rem;
        }
    </style>

    <script>
        (function () {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            function postToggle(id) {
                return fetch(`/items/toggle-ajax/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                });
            }

            document.addEventListener('change', function (e) {
                if (!e.target.classList.contains('avail-toggle')) return;
                const checkbox = e.target;
                const id = checkbox.getAttribute('data-id');
                // optimistically toggle; if server errors, revert
                const prev = !checkbox.checked;
                postToggle(id).then(resp => {
                    if (!resp.ok) {
                        checkbox.checked = prev;
                        alert('Update failed');
                    }
                }).catch(err => {
                    checkbox.checked = prev;
                    alert('Update failed');
                });
            });

            // Intercept Set All Available form to stay on the same page
            const setAllAvailableForm = document.querySelector('.set-all-available-form');
            if (setAllAvailableForm) {
                setAllAvailableForm.addEventListener('submit', function (ev) {
                    ev.preventDefault();
                    fetch(setAllAvailableForm.getAttribute('action'), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            [csrfHeader]: csrfToken
                        },
                        body: ''
                    }).then(resp => {
                        if (resp.ok) {
                            // reload the same page to reflect changes
                            window.location.reload();
                        } else {
                            alert('Update failed');
                        }
                    }).catch(err => {
                        alert('Update failed');
                    });
                });
            }

            // Same behavior for Unavailable and KG Available forms
            const setAllUnavailableForm = document.querySelector('.set-all-unavailable-form');
            if (setAllUnavailableForm) {
                setAllUnavailableForm.addEventListener('submit', function (ev) {
                    ev.preventDefault();
                    fetch(setAllUnavailableForm.getAttribute('action'), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            [csrfHeader]: csrfToken
                        },
                        body: ''
                    }).then(resp => {
                        if (resp.ok) {
                            window.location.reload();
                        } else {
                            alert('Update failed');
                        }
                    }).catch(err => {
                        alert('Update failed');
                    });
                });
            }

            const setAllKgForm = document.querySelector('.set-all-kg-form');
            if (setAllKgForm) {
                setAllKgForm.addEventListener('submit', function (ev) {
                    ev.preventDefault();
                    fetch(setAllKgForm.getAttribute('action'), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            [csrfHeader]: csrfToken
                        },
                        body: ''
                    }).then(resp => {
                        if (resp.ok) {
                            window.location.reload();
                        } else {
                            alert('Update failed');
                        }
                    }).catch(err => {
                        alert('Update failed');
                    });
                });
            }
        })();
    </script>
</body>

</html>